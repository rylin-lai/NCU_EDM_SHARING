name: TLSH Analyzer Test Suite
# TLSH åˆ†æå™¨æ¸¬è©¦å¥—ä»¶

on:
  pull_request:
    branches: "*"
    paths:
      - '**.py'
      - '**.go'
      - 'golang/**'
      - 'pylib/**'
      - 'test_*.py'
      - '.github/workflows/**'
  push:
    branches:  "*"
    paths:
      - '**.py'
      - '**.go'
      - 'golang/**'
      - 'pylib/**'
      - 'test_*.py'
      - '.github/workflows/**'

jobs:
  test-python:
    name: Test Python Implementation
    # æ¸¬è©¦ Python å¯¦ä½œ
    runs-on: ubuntu-20.04
    
    strategy:
      matrix:
        python-version: [3.8, 3.9, "3.10", "3.11"]
    
    steps:
    - name: Checkout code / æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install system dependencies / å®‰è£ç³»çµ±ä¾è³´
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
        
    - name: Install Python dependencies / å®‰è£ Python ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install tlsh-python numpy pandas matplotlib pytest
        # å®‰è£æ¸¬è©¦æ‰€éœ€çš„é¡å¤–å¥—ä»¶ / Install additional packages for testing
        pip install pytest-mock pytest-cov
        
    - name: Test Python simple text analyzer / æ¸¬è©¦ Python ç°¡åŒ–ç‰ˆæ–‡å­—åˆ†æå™¨
      working-directory: ./workshop_materials
      run: |
        echo "ğŸ Testing Python simple text analyzer / æ¸¬è©¦ Python ç°¡åŒ–ç‰ˆæ–‡å­—åˆ†æå™¨"
        
        # æ¸¬è©¦å…§å»ºç¯„ä¾‹ / Test built-in example
        python tlsh_text_analyzer.py --example --verbose
        
        # æ¸¬è©¦è‡ªè¨‚æ–‡å­—æ¯”è¼ƒ / Test custom text comparison
        python tlsh_text_analyzer.py \
          --text1="é€™æ˜¯ç¬¬ä¸€å€‹æ¸¬è©¦æ–‡å­—ï¼Œç”¨ä¾†æª¢é©— TLSH åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œã€‚æ­¤æ–‡å­—åŒ…å«è¶³å¤ çš„å­—å…ƒæ•¸é‡ä»¥æ»¿è¶³ TLSH æœ€å°é•·åº¦è¦æ±‚ã€‚" \
          --text2="é€™æ˜¯ç¬¬äºŒå€‹æ¸¬è©¦æ–‡å­—ï¼Œç”¨ä¾†æª¢é©— TLSH åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œï¼æ­¤æ–‡å­—åŒ…å«è¶³å¤ çš„å­—å…ƒæ•¸é‡ä»¥æ»¿è¶³ TLSH æœ€å°é•·åº¦è¦æ±‚ã€‚" \
          --verbose
          
        # æ¸¬è©¦ JSON è¼¸å‡º / Test JSON output
        python tlsh_text_analyzer.py --example --output test_result.json
        ls -la test_result.json
        cat test_result.json
        
    - name: Run pytest tests / åŸ·è¡Œ pytest æ¸¬è©¦
      working-directory: ./workshop_materials
      run: |
        echo "ğŸ§ª Running pytest tests / åŸ·è¡Œ pytest æ¸¬è©¦"
        
        # åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š / Run all tests with coverage report
        python -m pytest test_tlsh_analyzer.py -v --tb=short --cov=tlsh_text_analyzer --cov-report=term-missing
        
        # åŸ·è¡Œç‰¹å®šæ¸¬è©¦é¡åˆ¥ / Run specific test classes
        python -m pytest test_tlsh_analyzer.py::TestTLSHAnalyzer -v
        
    - name: Test Python full analyzer (pylib) / æ¸¬è©¦ Python å®Œæ•´ç‰ˆåˆ†æå™¨
      working-directory: ./workshop_materials
      run: |
        echo "ğŸ”¬ Testing Python full analyzer / æ¸¬è©¦ Python å®Œæ•´ç‰ˆåˆ†æå™¨"
        
        # æ¸¬è©¦ pylib ä¸­çš„å®Œæ•´ç‰ˆåˆ†æå™¨ / Test full analyzer in pylib
        cd pylib
        python tlsh_analyzer.py case1 --example --verbose
        
    - name: Upload test results / ä¸Šå‚³æ¸¬è©¦çµæœ
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: python-test-results-${{ matrix.python-version }}
        path: |
          workshop_materials/test_result.json
          workshop_materials/pytest.log

  test-golang:
    name: Test Golang Implementation
    # æ¸¬è©¦ Golang å¯¦ä½œ
    runs-on: ubuntu-20.04
    
    strategy:
      matrix:
        go-version: [1.19, "1.20", 1.21]
    
    steps:
    - name: Checkout code / æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
        
    - name: Build Golang binary / å»ºç½® Golang binary
      working-directory: ./workshop_materials/golang
      run: |
        echo "ğŸ”§ Building Golang binary / å»ºç½® Golang binary"
        
        # æª¢æŸ¥ Go ç‰ˆæœ¬ / Check Go version
        go version
        
        # ä¸‹è¼‰ä¾è³´ / Download dependencies
        go mod tidy
        
        # å»ºç½® Linux binary / Build Linux binary
        GOOS=linux GOARCH=amd64 go build -o tlsh-text-analyzer-linux main.go
        
        # æª¢æŸ¥å»ºç½®çµæœ / Check build result
        ls -la tlsh-text-analyzer-linux
        file tlsh-text-analyzer-linux
        
    - name: Test Golang binary / æ¸¬è©¦ Golang binary
      working-directory: ./workshop_materials/golang
      run: |
        echo "ğŸš€ Testing Golang binary / æ¸¬è©¦ Golang binary"
        
        # æ¸¬è©¦èªªæ˜æ–‡ä»¶ / Test help documentation
        ./tlsh-text-analyzer-linux -help
        
        # æ¸¬è©¦å…§å»ºç¯„ä¾‹ / Test built-in example
        ./tlsh-text-analyzer-linux -example -verbose
        
        # æ¸¬è©¦è‡ªè¨‚æ–‡å­—æ¯”è¼ƒ / Test custom text comparison
        ./tlsh-text-analyzer-linux \
          -text1="é€™æ˜¯ç¬¬ä¸€å€‹æ¸¬è©¦æ–‡å­—ï¼Œç”¨ä¾†æª¢é©— TLSH åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œã€‚æ­¤æ–‡å­—åŒ…å«è¶³å¤ çš„å­—å…ƒæ•¸é‡ä»¥æ»¿è¶³ TLSH æœ€å°é•·åº¦è¦æ±‚ã€‚" \
          -text2="é€™æ˜¯ç¬¬äºŒå€‹æ¸¬è©¦æ–‡å­—ï¼Œç”¨ä¾†æª¢é©— TLSH åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œï¼æ­¤æ–‡å­—åŒ…å«è¶³å¤ çš„å­—å…ƒæ•¸é‡ä»¥æ»¿è¶³ TLSH æœ€å°é•·åº¦è¦æ±‚ã€‚" \
          -verbose
          
        # æ¸¬è©¦ JSON è¼¸å‡º / Test JSON output
        ./tlsh-text-analyzer-linux -example -output golang_result.json -verbose
        ls -la golang_result.json
        cat golang_result.json
        
    - name: Upload Golang artifacts / ä¸Šå‚³ Golang ç”¢ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: golang-binary-${{ matrix.go-version }}
        path: |
          workshop_materials/golang/tlsh-text-analyzer-linux
          workshop_materials/golang/golang_result.json

  cross-validation:
    name: Cross-language Validation
    # è·¨èªè¨€é©—è­‰
    needs: [test-python, test-golang]
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout code / æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: Set up Python / è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Set up Go / è¨­ç½® Go  
      uses: actions/setup-go@v4
      with:
        go-version: "1.20"
        
    - name: Install dependencies / å®‰è£ä¾è³´
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake jq
        python -m pip install --upgrade pip
        pip install tlsh-python
        
    - name: Build Golang binary / å»ºç½® Golang binary
      working-directory: ./workshop_materials/golang
      run: |
        go mod tidy
        GOOS=linux GOARCH=amd64 go build -o tlsh-text-analyzer-linux main.go
        
    - name: Cross-language comparison test / è·¨èªè¨€æ¯”è¼ƒæ¸¬è©¦
      working-directory: ./workshop_materials
      run: |
        echo "ğŸ”„ Cross-language comparison test / è·¨èªè¨€æ¯”è¼ƒæ¸¬è©¦"
        
        # å®šç¾©æ¸¬è©¦æ–‡å­— / Define test texts
        TEST_TEXT1="é€™æ˜¯ä¸€å€‹è·¨èªè¨€æ¸¬è©¦æ–‡å­—ï¼Œç”¨ä¾†é©—è­‰ Python å’Œ Golang ç‰ˆæœ¬çš„ TLSH å¯¦ä½œæ˜¯å¦ç”¢ç”Ÿä¸€è‡´çš„çµæœã€‚æ­¤æ–‡å­—åŒ…å«è¶³å¤ çš„å­—å…ƒæ•¸é‡ä»¥æ»¿è¶³ TLSH æœ€å°é•·åº¦è¦æ±‚ï¼Œä¸¦ä¸”åŒ…å«ä¸­æ–‡å­—ç¬¦ä»¥æ¸¬è©¦ UTF-8 ç·¨ç¢¼è™•ç†ã€‚"
        TEST_TEXT2="é€™æ˜¯ä¸€å€‹è·¨èªè¨€æ¸¬è©¦æ–‡å­—ï¼Œç”¨ä¾†é©—è­‰ Python å’Œ Golang ç‰ˆæœ¬çš„ TLSH å¯¦ä½œæ˜¯å¦ç”¢ç”Ÿä¸€è‡´çš„çµæœï¼æ­¤æ–‡å­—åŒ…å«è¶³å¤ çš„å­—å…ƒæ•¸é‡ä»¥æ»¿è¶³ TLSH æœ€å°é•·åº¦è¦æ±‚ï¼Œä¸¦ä¸”åŒ…å«ä¸­æ–‡å­—ç¬¦ä»¥æ¸¬è©¦ UTF-8 ç·¨ç¢¼è™•ç†ã€‚"
        
        # åŸ·è¡Œ Python ç‰ˆæœ¬ / Run Python version
        echo "åŸ·è¡Œ Python ç‰ˆæœ¬ / Running Python version"
        python tlsh_text_analyzer.py \
          --text1="$TEST_TEXT1" \
          --text2="$TEST_TEXT2" \
          --output python_cross_test.json
          
        # åŸ·è¡Œ Golang ç‰ˆæœ¬ / Run Golang version
        echo "åŸ·è¡Œ Golang ç‰ˆæœ¬ / Running Golang version"  
        ./golang/tlsh-text-analyzer-linux \
          -text1="$TEST_TEXT1" \
          -text2="$TEST_TEXT2" \
          -output golang_cross_test.json
          
        # æ¯”è¼ƒçµæœ / Compare results
        echo "ğŸ” Comparing results / æ¯”è¼ƒçµæœ"
        echo "Python result / Python çµæœ:"
        cat python_cross_test.json | jq '.'
        echo ""
        echo "Golang result / Golang çµæœ:"
        cat golang_cross_test.json | jq '.'
        
        # æå–è·é›¢å€¼é€²è¡Œæ¯”è¼ƒ / Extract distance values for comparison
        PYTHON_DISTANCE=$(cat python_cross_test.json | jq '.distance')
        GOLANG_DISTANCE=$(cat golang_cross_test.json | jq '.distance')
        
        echo ""
        echo "Distance comparison / è·é›¢æ¯”è¼ƒ:"
        echo "Python distance: $PYTHON_DISTANCE"
        echo "Golang distance: $GOLANG_DISTANCE"
        
        # æª¢æŸ¥è·é›¢æ˜¯å¦æ¥è¿‘ï¼ˆå…è¨±å°å¹…å·®ç•°ï¼‰/ Check if distances are close (allow small differences)
        if [ "$PYTHON_DISTANCE" -eq "$GOLANG_DISTANCE" ]; then
          echo "âœ… Perfect match! / å®Œç¾åŒ¹é…ï¼"
        else
          # è¨ˆç®—å·®ç•°ç™¾åˆ†æ¯” / Calculate difference percentage
          DIFF=$(echo "scale=2; ($PYTHON_DISTANCE - $GOLANG_DISTANCE) / $PYTHON_DISTANCE * 100" | bc -l || echo "0")
          echo "Difference: $DIFF%"
          
          # å¦‚æœå·®ç•°å°æ–¼10%å‰‡èªç‚ºå¯æ¥å— / Accept if difference is less than 10%
          if (( $(echo "$DIFF < 10" | bc -l) )); then
            echo "âœ… Acceptable difference (< 10%) / å¯æ¥å—çš„å·®ç•° (< 10%)"
          else
            echo "âŒ Significant difference detected / æª¢æ¸¬åˆ°é¡¯è‘—å·®ç•°"
            exit 1
          fi
        fi
        
    - name: Upload cross-validation results / ä¸Šå‚³è·¨èªè¨€é©—è­‰çµæœ
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: cross-validation-results
        path: |
          workshop_materials/python_cross_test.json
          workshop_materials/golang_cross_test.json

  performance-benchmark:
    name: Performance Benchmark
    # æ•ˆèƒ½åŸºæº–æ¸¬è©¦
    needs: [test-python, test-golang]
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout code / æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: Set up Python / è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Set up Go / è¨­ç½® Go
      uses: actions/setup-go@v4
      with:
        go-version: "1.20"
        
    - name: Install dependencies / å®‰è£ä¾è³´
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake time
        python -m pip install --upgrade pip
        pip install tlsh-python
        
    - name: Build Golang binary / å»ºç½® Golang binary
      working-directory: ./workshop_materials/golang
      run: |
        go mod tidy
        GOOS=linux GOARCH=amd64 go build -o tlsh-text-analyzer-linux main.go
        
    - name: Performance benchmark / æ•ˆèƒ½åŸºæº–æ¸¬è©¦
      working-directory: ./workshop_materials
      run: |
        echo "âš¡ Performance benchmark / æ•ˆèƒ½åŸºæº–æ¸¬è©¦"
        
        # å»ºç«‹æ¸¬è©¦æ–‡å­— / Create test text
        TEST_TEXT="$(for i in {1..100}; do echo "é€™æ˜¯ä¸€å€‹æ•ˆèƒ½æ¸¬è©¦æ–‡å­—ï¼Œé‡è¤‡å…§å®¹ç”¨ä¾†æ¸¬è©¦ TLSH è¨ˆç®—æ•ˆèƒ½ã€‚åŒ…å«ä¸­æ–‡å­—ç¬¦ä»¥æ¸¬è©¦ UTF-8 ç·¨ç¢¼è™•ç†æ•ˆèƒ½ã€‚"; done)"
        
        echo "Text length: ${#TEST_TEXT} characters / æ–‡å­—é•·åº¦ï¼š${#TEST_TEXT} å­—ç¬¦"
        echo ""
        
        # Python æ•ˆèƒ½æ¸¬è©¦ / Python performance test
        echo "ğŸ Python performance test / Python æ•ˆèƒ½æ¸¬è©¦"
        /usr/bin/time -v python tlsh_text_analyzer.py \
          --text1="$TEST_TEXT" \
          --text2="$TEST_TEXT ä¿®æ”¹ç‰ˆ" \
          2>&1 | grep -E "(Elapsed|Maximum|User|System)"
          
        echo ""
        
        # Golang æ•ˆèƒ½æ¸¬è©¦ / Golang performance test  
        echo "ğŸš€ Golang performance test / Golang æ•ˆèƒ½æ¸¬è©¦"
        /usr/bin/time -v ./golang/tlsh-text-analyzer-linux \
          -text1="$TEST_TEXT" \
          -text2="$TEST_TEXT ä¿®æ”¹ç‰ˆ" \
          2>&1 | grep -E "(Elapsed|Maximum|User|System)"

  summary:
    name: Test Summary
    # æ¸¬è©¦æ‘˜è¦
    needs: [test-python, test-golang, cross-validation, performance-benchmark]
    runs-on: ubuntu-20.04
    if: always()
    
    steps:
    - name: Test Summary / æ¸¬è©¦æ‘˜è¦
      run: |
        echo "ğŸ“Š TLSH Analyzer Test Summary / TLSH åˆ†æå™¨æ¸¬è©¦æ‘˜è¦"
        echo "========================================="
        echo ""
        
        # æª¢æŸ¥å„å€‹ job çš„ç‹€æ…‹ / Check status of each job
        echo "Job Results / ä½œæ¥­çµæœ:"
        echo "â€¢ Python Tests: ${{ needs.test-python.result }}"
        echo "â€¢ Golang Tests: ${{ needs.test-golang.result }}"  
        echo "â€¢ Cross Validation: ${{ needs.cross-validation.result }}"
        echo "â€¢ Performance Benchmark: ${{ needs.performance-benchmark.result }}"
        echo ""
        
        if [[ "${{ needs.test-python.result }}" == "success" && "${{ needs.test-golang.result }}" == "success" && "${{ needs.cross-validation.result }}" == "success" ]]; then
          echo "âœ… All core tests passed! / æ‰€æœ‰æ ¸å¿ƒæ¸¬è©¦é€šéï¼"
          echo "ğŸ‰ TLSH Analyzer is ready for merge / TLSH åˆ†æå™¨æº–å‚™å¥½åˆä½µ"
        else
          echo "âŒ Some tests failed / éƒ¨åˆ†æ¸¬è©¦å¤±æ•—"
          echo "Please check the individual job logs / è«‹æª¢æŸ¥å„å€‹ä½œæ¥­çš„æ—¥èªŒ"
        fi
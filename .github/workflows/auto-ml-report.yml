name: ðŸ¤– Automated ML Report Generation

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:
    inputs:
      dataset_size:
        description: 'Number of students in generated dataset'
        required: false
        default: '500'
        type: string
      semester:
        description: 'Semester identifier'
        required: false
        default: '2024_Fall'
        type: string

jobs:
  generate-dataset:
    name: ðŸ“Š Generate Educational Dataset
    runs-on: ubuntu-latest
    
    outputs:
      dataset-path: ${{ steps.generate.outputs.dataset-path }}
      
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
    
    - name: ðŸ“Š Generate Educational Dataset
      id: generate
      working-directory: auto_ml_demo
      run: |
        mkdir -p data
        
        STUDENTS=${{ github.event.inputs.dataset_size || '500' }}
        SEMESTER=${{ github.event.inputs.semester || '2024_Fall' }}
        
        echo "ðŸ”„ Generating dataset with $STUDENTS students for semester $SEMESTER"
        
        python educational_dataset_generator.py \
          --students $STUDENTS \
          --semester $SEMESTER \
          --output data/ \
          --both
        
        DATASET_PATH="data/educational_data_${SEMESTER}.csv"
        echo "dataset-path=$DATASET_PATH" >> $GITHUB_OUTPUT
        
        echo "âœ… Dataset generated: $DATASET_PATH"
        ls -la data/
    
    - name: ðŸ“¤ Upload Dataset Artifact
      uses: actions/upload-artifact@v3
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        retention-days: 30

  run-ml-analysis:
    name: ðŸ¤– Run ML Analysis
    needs: generate-dataset
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
        
    - name: ðŸ“¥ Download Dataset
      uses: actions/download-artifact@v3
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        
    - name: ðŸ¤– Run ML Analysis
      working-directory: auto_ml_demo
      run: |
        echo "ðŸ”„ Running ML analysis on dataset: ${{ needs.generate-dataset.outputs.dataset-path }}"
        
        mkdir -p reports/plots
        
        python ml_report_generator.py \
          --data ${{ needs.generate-dataset.outputs.dataset-path }} \
          --output reports/ \
          --target Pass_course
        
        echo "âœ… ML analysis completed"
        ls -la reports/
        
    - name: ðŸ“¤ Upload ML Reports
      uses: actions/upload-artifact@v3
      with:
        name: ml-analysis-reports
        path: auto_ml_demo/reports/
        retention-days: 30

  deploy-to-pages:
    name: ðŸš€ Deploy to GitHub Pages
    needs: [generate-dataset, run-ml-analysis]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download ML Reports
      uses: actions/download-artifact@v3
      with:
        name: ml-analysis-reports
        path: reports/
        
    - name: ðŸ Set up Python for Pages Structure
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ—ï¸ Create Pages Structure
      working-directory: auto_ml_demo
      run: |
        python create_pages_structure.py
        echo "âœ… GitHub Pages structure created"
        find public -type f | head -10
        
    - name: ðŸ“¤ Setup Pages
      uses: actions/configure-pages@v3
      
    - name: ðŸ“¤ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: auto_ml_demo/public/
        
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  notify-completion:
    name: ðŸ“§ Notify Completion
    needs: [generate-dataset, run-ml-analysis, deploy-to-pages]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Create Summary Report
      run: |
        echo "## ðŸ¤– Automated ML Analysis Completion Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Dataset Generation**: ${{ needs.generate-dataset.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ML Analysis**: ${{ needs.run-ml-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Pages Deployment**: ${{ needs.deploy-to-pages.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Key Features Demonstrated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Automated dataset generation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Multi-model ML analysis pipeline" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Automated report generation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… GitHub Pages deployment" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Cross-platform CI/CD automation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“š Educational Value" >> $GITHUB_STEP_SUMMARY
        echo "This workflow demonstrates enterprise Python automation:" >> $GITHUB_STEP_SUMMARY
        echo "1. **Data Generation**: Synthetic educational datasets" >> $GITHUB_STEP_SUMMARY
        echo "2. **ML Pipeline**: scikit-learn classification & clustering" >> $GITHUB_STEP_SUMMARY
        echo "3. **Visualization**: matplotlib & seaborn charts" >> $GITHUB_STEP_SUMMARY
        echo "4. **Reporting**: Automated HTML report generation" >> $GITHUB_STEP_SUMMARY
        echo "5. **Deployment**: GitHub Actions + GitHub Pages integration" >> $GITHUB_STEP_SUMMARY

    - name: ðŸŽ‰ Success Notification
      if: needs.deploy-to-pages.result == 'success'
      run: |
        echo "ðŸŽ‰ ML Analysis Pipeline completed successfully!"
        echo "ðŸ“Š Report available at GitHub Pages"
        echo "ðŸ¤– Perfect demonstration of Python enterprise automation!"
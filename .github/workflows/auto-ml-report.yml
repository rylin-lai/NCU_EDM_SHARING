name: ü§ñ Automated ML Report Generation

on:
  push:
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  pull_request:
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  workflow_dispatch:
    inputs:
      dataset_size:
        description: 'Number of students in generated dataset'
        required: false
        default: '500'
        type: string
      semester:
        description: 'Semester identifier'
        required: false
        default: '2024_Fall'
        type: string

jobs:
  setup-deployment-info:
    name: üìã Setup Deployment Info
    runs-on: ubuntu-latest
    outputs:
      deployment-path: ${{ steps.path-info.outputs.deployment-path }}
      branch-name: ${{ steps.path-info.outputs.branch-name }}
      is-main-branch: ${{ steps.path-info.outputs.is-main-branch }}
      pr-number: ${{ steps.path-info.outputs.pr-number }}
      
    steps:
    - name: üîç Determine Deployment Path
      id: path-info
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          PR_NUMBER="${{ github.event.pull_request.number }}"
          DEPLOYMENT_PATH="pr-${PR_NUMBER}"
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          IS_MAIN_BRANCH="false"
          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref_name }}" = "main" ] || [ "${{ github.ref_name }}" = "master" ]; then
          DEPLOYMENT_PATH=""
          BRANCH_NAME="${{ github.ref_name }}"
          IS_MAIN_BRANCH="true"
          echo "pr-number=" >> $GITHUB_OUTPUT
        else
          BRANCH_NAME="${{ github.ref_name }}"
          DEPLOYMENT_PATH="branch-${BRANCH_NAME}"
          IS_MAIN_BRANCH="false"
          echo "pr-number=" >> $GITHUB_OUTPUT
        fi
        
        echo "deployment-path=${DEPLOYMENT_PATH}" >> $GITHUB_OUTPUT
        echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "is-main-branch=${IS_MAIN_BRANCH}" >> $GITHUB_OUTPUT
        
        echo "üîç Deployment Info:"
        echo "  Branch: ${BRANCH_NAME}"
        echo "  Path: ${DEPLOYMENT_PATH}"
        echo "  Is Main: ${IS_MAIN_BRANCH}"

  generate-dataset:
    name: üìä Generate Educational Dataset
    runs-on: ubuntu-latest
    needs: setup-deployment-info
    
    outputs:
      dataset-path: ${{ steps.generate.outputs.dataset-path }}
      
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
    
    - name: üìä Generate Educational Dataset
      id: generate
      working-directory: auto_ml_demo
      run: |
        mkdir -p data
        
        STUDENTS=${{ github.event.inputs.dataset_size || '500' }}
        SEMESTER=${{ github.event.inputs.semester || '2024_Fall' }}
        
        echo "üîÑ Generating dataset with $STUDENTS students for semester $SEMESTER"
        
        python educational_dataset_generator.py \
          --students $STUDENTS \
          --semester $SEMESTER \
          --output data/ \
          --both
        
        DATASET_PATH="data/educational_data_${SEMESTER}.csv"
        echo "dataset-path=$DATASET_PATH" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Dataset generated: $DATASET_PATH"
        ls -la data/
    
    - name: üì§ Upload Dataset Artifact
      uses: actions/upload-artifact@v4
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        retention-days: 30

  run-ml-analysis:
    name: ü§ñ Run ML Analysis
    needs: [setup-deployment-info, generate-dataset]
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
        
    - name: üì• Download Dataset
      uses: actions/download-artifact@v4
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        
    - name: ü§ñ Run ML Analysis
      working-directory: auto_ml_demo
      run: |
        echo "üîÑ Running ML analysis on dataset: ${{ needs.generate-dataset.outputs.dataset-path }}"
        
        mkdir -p reports/plots
        
        python ml_report_generator.py \
          --data ${{ needs.generate-dataset.outputs.dataset-path }} \
          --output reports/ \
          --target Pass_course
        
        echo "‚úÖ ML analysis completed"
        ls -la reports/
        
    - name: üì§ Upload ML Reports
      uses: actions/upload-artifact@v4
      with:
        name: ml-analysis-reports
        path: auto_ml_demo/reports/
        retention-days: 30

  deploy-to-pages:
    name: üöÄ Deploy to GitHub Pages
    needs: [setup-deployment-info, generate-dataset, run-ml-analysis]
    runs-on: ubuntu-latest
    if: success()
    
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: üì• Download ML Reports
      uses: actions/download-artifact@v4
      with:
        name: ml-analysis-reports
        path: reports/
        
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: üèóÔ∏è Prepare HTML Report Before Branch Switch
      run: |
        # Create HTML report using create_pages_structure.py BEFORE switching branches
        cd auto_ml_demo
        python create_pages_structure.py
        
        # Copy all needed files to /tmp for later use
        mkdir -p /tmp/deployment-files
        cp -r public/* /tmp/deployment-files/
        cp -r ../reports /tmp/deployment-files/ 2>/dev/null || echo "No reports directory"
        
        echo "üì¶ Prepared all deployment files in /tmp/deployment-files"
        ls -la /tmp/deployment-files/
        
    - name: üì• Switch to gh-pages and Deploy
      run: |
        # Clean working directory before branch switch  
        git clean -fd
        
        # Fetch or create gh-pages branch
        git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages
        git checkout gh-pages
        
        if [ ! -f "index.html" ]; then
          # Only clean if it's a completely new gh-pages branch
          git rm -rf . 2>/dev/null || true
          echo "üìÑ Created new gh-pages branch"
        else
          echo "üìÑ Using existing gh-pages branch with existing content"
          # Don't clean existing files - we want to keep other branch directories
        fi
        
    - name: üöÄ Deploy Files to Target Directory
      env:
        DEPLOYMENT_PATH: ${{ needs.setup-deployment-info.outputs.deployment-path }}
        BRANCH_NAME: ${{ needs.setup-deployment-info.outputs.branch-name }}
        IS_MAIN_BRANCH: ${{ needs.setup-deployment-info.outputs.is-main-branch }}
        PR_NUMBER: ${{ needs.setup-deployment-info.outputs.pr-number }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        echo "üîÑ Deploying branch: ${BRANCH_NAME}"
        
        # Determine target directory
        if [ "${IS_MAIN_BRANCH}" = "true" ]; then
          TARGET_DIR="."
          echo "üìÅ Main branch -> root directory"
        else
          TARGET_DIR="branch-${BRANCH_NAME}"
          echo "üìÅ Branch '${BRANCH_NAME}' -> directory '${TARGET_DIR}'"
        fi
        
        # Create target directory
        mkdir -p "${TARGET_DIR}"
        
        # Show existing content before deployment
        echo "üìÇ Current gh-pages content:"
        ls -la . || echo "Empty directory"
        
        # Copy the prepared files from /tmp to target directory
        if [ -f "/tmp/deployment-files/index.html" ]; then
          cp /tmp/deployment-files/index.html "${TARGET_DIR}/"
          echo "‚úÖ Deployed comprehensive ML report to ${TARGET_DIR}/"
        else
          echo "‚ö†Ô∏è No prepared HTML file found, creating simple placeholder"
          echo "<h1>ü§ñ Python ML Demo - ${BRANCH_NAME}</h1><p>Report deployment in progress...</p>" > "${TARGET_DIR}/index.html"
        fi
        
        # Show what we deployed
        echo "üìÅ Deployed files for ${BRANCH_NAME}:"
        ls -la "${TARGET_DIR}/"
        
        # Show all content after deployment
        echo "üìÇ All gh-pages content after deployment:"
        ls -la .
        
    - name: üì§ Commit and Push to gh-pages
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add .
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Deploy ML report for branch: ${{ needs.setup-deployment-info.outputs.branch-name }}"
          git push origin gh-pages
          echo "‚úÖ Successfully pushed to gh-pages"
        fi

  notify-completion:
    name: üìß Notify Completion
    needs: [setup-deployment-info, generate-dataset, run-ml-analysis, deploy-to-pages]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: üéâ Success Notification
      if: needs.deploy-to-pages.result == 'success'
      run: |
        BRANCH_NAME="${{ needs.setup-deployment-info.outputs.branch-name }}"
        IS_MAIN_BRANCH="${{ needs.setup-deployment-info.outputs.is-main-branch }}"
        BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        
        if [ "${IS_MAIN_BRANCH}" = "true" ]; then
          FULL_URL="${BASE_URL}/"
        else
          FULL_URL="${BASE_URL}/branch-${BRANCH_NAME}/"
        fi
        
        echo "üéâ ML Analysis Pipeline completed successfully!"
        echo "üìä Report URL: $FULL_URL"
        echo "üìä Branch: ${{ needs.setup-deployment-info.outputs.branch-name }}"
        
        echo "## üéâ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Access Your ML Report:" >> $GITHUB_STEP_SUMMARY
        echo "**üîó [Click here to view the report]($FULL_URL)**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ needs.setup-deployment-info.outputs.branch-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Path**: $DEPLOYMENT_PATH" >> $GITHUB_STEP_SUMMARY
        echo "- **Direct URL**: [$FULL_URL]($FULL_URL)" >> $GITHUB_STEP_SUMMARY
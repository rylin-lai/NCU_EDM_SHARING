name: ü§ñ Automated ML Report Generation

on:
  push:
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  pull_request:
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  workflow_dispatch:
    inputs:
      dataset_size:
        description: 'Number of students in generated dataset'
        required: false
        default: '500'
        type: string
      semester:
        description: 'Semester identifier'
        required: false
        default: '2024_Fall'
        type: string

jobs:
  setup-deployment-info:
    name: üìã Setup Deployment Info
    runs-on: ubuntu-latest
    outputs:
      deployment-path: ${{ steps.path-info.outputs.deployment-path }}
      branch-name: ${{ steps.path-info.outputs.branch-name }}
      is-main-branch: ${{ steps.path-info.outputs.is-main-branch }}
      pr-number: ${{ steps.path-info.outputs.pr-number }}
      
    steps:
    - name: üîç Determine Deployment Path
      id: path-info
      run: |
        # Á¢∫ÂÆöÈÉ®ÁΩ≤Ë∑ØÂæëÂíåÂàÜÊîØË≥áË®ä
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PR ÈÉ®ÁΩ≤Âà∞ pr-{number} Ë∑ØÂæë
          PR_NUMBER="${{ github.event.pull_request.number }}"
          DEPLOYMENT_PATH="pr-${PR_NUMBER}"
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          IS_MAIN_BRANCH="false"
          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref_name }}" = "main" ] || [ "${{ github.ref_name }}" = "master" ]; then
          # main/master ÂàÜÊîØÈÉ®ÁΩ≤Âà∞Ê†πË∑ØÂæë
          DEPLOYMENT_PATH=""
          BRANCH_NAME="${{ github.ref_name }}"
          IS_MAIN_BRANCH="true"
          echo "pr-number=" >> $GITHUB_OUTPUT
        else
          # ÂÖ∂‰ªñÂàÜÊîØÈÉ®ÁΩ≤Âà∞ branch-{name} Ë∑ØÂæë
          BRANCH_NAME="${{ github.ref_name }}"
          DEPLOYMENT_PATH="branch-${BRANCH_NAME}"
          IS_MAIN_BRANCH="false"
          echo "pr-number=" >> $GITHUB_OUTPUT
        fi
        
        echo "deployment-path=${DEPLOYMENT_PATH}" >> $GITHUB_OUTPUT
        echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "is-main-branch=${IS_MAIN_BRANCH}" >> $GITHUB_OUTPUT
        
        echo "üîç Deployment Info:"
        echo "  Branch: ${BRANCH_NAME}"
        echo "  Path: ${DEPLOYMENT_PATH}"
        echo "  Is Main: ${IS_MAIN_BRANCH}"

  generate-dataset:
    name: üìä Generate Educational Dataset
    runs-on: ubuntu-latest
    needs: setup-deployment-info
    
    outputs:
      dataset-path: ${{ steps.generate.outputs.dataset-path }}
      
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
    
    - name: üìä Generate Educational Dataset
      id: generate
      working-directory: auto_ml_demo
      run: |
        mkdir -p data
        
        STUDENTS=${{ github.event.inputs.dataset_size || '500' }}
        SEMESTER=${{ github.event.inputs.semester || '2024_Fall' }}
        
        echo "üîÑ Generating dataset with $STUDENTS students for semester $SEMESTER"
        
        python educational_dataset_generator.py \
          --students $STUDENTS \
          --semester $SEMESTER \
          --output data/ \
          --both
        
        DATASET_PATH="data/educational_data_${SEMESTER}.csv"
        echo "dataset-path=$DATASET_PATH" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Dataset generated: $DATASET_PATH"
        ls -la data/
    
    - name: üì§ Upload Dataset Artifact
      uses: actions/upload-artifact@v4
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        retention-days: 30

  run-ml-analysis:
    name: ü§ñ Run ML Analysis
    needs: [setup-deployment-info, generate-dataset]
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
        
    - name: üì• Download Dataset
      uses: actions/download-artifact@v4
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        
    - name: ü§ñ Run ML Analysis
      working-directory: auto_ml_demo
      run: |
        echo "üîÑ Running ML analysis on dataset: ${{ needs.generate-dataset.outputs.dataset-path }}"
        
        mkdir -p reports/plots
        
        python ml_report_generator.py \
          --data ${{ needs.generate-dataset.outputs.dataset-path }} \
          --output reports/ \
          --target Pass_course
        
        echo "‚úÖ ML analysis completed"
        ls -la reports/
        
    - name: üì§ Upload ML Reports
      uses: actions/upload-artifact@v4
      with:
        name: ml-analysis-reports
        path: auto_ml_demo/reports/
        retention-days: 30

  deploy-to-pages:
    name: üöÄ Deploy to GitHub Pages (Multi-Branch)
    needs: [setup-deployment-info, generate-dataset, run-ml-analysis]
    runs-on: ubuntu-latest
    if: success()
    
    permissions:
      contents: write  # Need write permission to push to gh-pages
      pages: write
      id-token: write
      actions: read
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: üì• Download ML Reports
      uses: actions/download-artifact@v4
      with:
        name: ml-analysis-reports
        path: reports/
        
    - name: üêç Set up Python for Pages Structure
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: üì• Checkout/Create gh-pages branch
      run: |
        # Try to checkout existing gh-pages branch, or create new one
        git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages
        git checkout gh-pages
        
        # If it's a new branch, clean it
        if [ ! -f "index.html" ]; then
          git rm -rf . 2>/dev/null || true
          echo "üìÑ Created new gh-pages branch"
        else
          echo "üìÑ Using existing gh-pages branch"
        fi
        
    - name: üèóÔ∏è Deploy Branch Reports to Sub-Directory
      env:
        DEPLOYMENT_PATH: ${{ needs.setup-deployment-info.outputs.deployment-path }}
        BRANCH_NAME: ${{ needs.setup-deployment-info.outputs.branch-name }}
        IS_MAIN_BRANCH: ${{ needs.setup-deployment-info.outputs.is-main-branch }}
        PR_NUMBER: ${{ needs.setup-deployment-info.outputs.pr-number }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        echo "üîÑ Deploying branch: ${BRANCH_NAME}"
        
        # Determine target directory
        if [ "${IS_MAIN_BRANCH}" = "true" ]; then
          TARGET_DIR="."
          echo "üìÅ Main branch -> root directory"
        else
          TARGET_DIR="branch-${BRANCH_NAME}"
          echo "üìÅ Branch '${BRANCH_NAME}' -> directory '${TARGET_DIR}'"
        fi
        
        # Create target directory
        mkdir -p "${TARGET_DIR}"
        
        # Copy reports to target directory  
        cd auto_ml_demo
        python create_pages_structure.py
        cd ..
        
        # Copy generated reports
        if [ "${IS_MAIN_BRANCH}" = "true" ]; then
          cp -r auto_ml_demo/public/* .
        else
          cp -r auto_ml_demo/public/* "${TARGET_DIR}/"
        fi
        
        # Update deployments registry
        python - << 'EOF'
        import os
        import json
        import datetime
        from pathlib import Path
        
        deployment_path = os.environ.get('DEPLOYMENT_PATH', '')
        branch_name = os.environ.get('BRANCH_NAME', 'unknown')
        is_main_branch = os.environ.get('IS_MAIN_BRANCH') == 'true'
        pr_number = os.environ.get('PR_NUMBER', '')
        repo_name = os.environ.get('GITHUB_REPOSITORY', '').split('/')[-1]
        actor = os.environ.get('GITHUB_ACTOR', 'unknown')
        
        # Read existing deployments
        deployments_file = Path('deployments.json')
        deployments = {}
        if deployments_file.exists():
            try:
                with open(deployments_file, 'r') as f:
                    deployments = json.load(f)
            except:
                deployments = {}
        
        # Update deployment info
        target_dir = "." if is_main_branch else f"branch-{branch_name}"
        deployment_info = {
            'branch': branch_name,
            'target_dir': target_dir,
            'is_main': is_main_branch,
            'pr_number': pr_number if pr_number else None,
            'actor': actor,
            'timestamp': datetime.datetime.now().isoformat(),
            'url': f"./{target_dir}/" if not is_main_branch else "./"
        }
        
        deployment_key = branch_name
        deployments[deployment_key] = deployment_info
        
        # Save deployments
        with open(deployments_file, 'w') as f:
            json.dump(deployments, f, indent=2)
        
        # Create main index if main branch
        if is_main_branch:
            main_index_html = f'''<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>üéì ML Workshop - All Branch Reports</title>
            <style>
                body {{ 
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                    margin: 0; padding: 20px; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                }}
                .container {{ 
                    max-width: 1200px; margin: 0 auto; 
                    background: white; border-radius: 15px; 
                    padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                }}
                .header {{ 
                    text-align: center; margin-bottom: 40px; 
                    padding: 20px; background: #f8f9fa; border-radius: 10px;
                }}
                .branches-grid {{ 
                    display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
                    gap: 20px; margin: 30px 0; 
                }}
                .branch-card {{ 
                    background: white; padding: 20px; border-radius: 10px; 
                    border: 2px solid #e9ecef; transition: all 0.3s ease;
                }}
                .branch-card:hover {{ transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }}
                .branch-card.main {{ border-left: 4px solid #28a745; }}
                .branch-card.branch {{ border-left: 4px solid #17a2b8; }}
                .branch-title {{ font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #495057; }}
                .branch-info {{ font-size: 14px; color: #6c757d; margin: 5px 0; }}
                .branch-link {{ 
                    display: inline-block; padding: 10px 20px; background: #007bff; 
                    color: white; text-decoration: none; border-radius: 6px; 
                    margin-top: 15px; transition: background 0.3s ease;
                }}
                .branch-link:hover {{ background: #0056b3; }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üéì ML Workshop - Branch Reports</h1>
                    <p>Each branch has its own ML analysis report</p>
                </div>
                <div class="branches-grid">'''
            
            for branch, info in sorted(deployments.items()):
                card_class = "main" if info['is_main'] else "branch"
                title = f"üè† Main Branch" if info['is_main'] else f"üåø Branch: {branch}"
                
                main_index_html += f'''
                    <div class="branch-card {card_class}">
                        <div class="branch-title">{title}</div>
                        <div class="branch-info">üë§ Author: {info['actor']}</div>
                        <div class="branch-info">üïí Updated: {info['timestamp'][:19].replace('T', ' ')}</div>
                        <a href="{info['url']}" class="branch-link">View Report ‚Üí</a>
                    </div>'''
            
            main_index_html += f'''
                </div>
                <div style="text-align: center; margin-top: 30px; color: #666;">
                    Last updated: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}<br>
                    Total branches: {len(deployments)}
                </div>
            </div>
        </body>
        </html>'''
            
            with open('index.html', 'w', encoding='utf-8') as f:
                f.write(main_index_html)
        
        print(f"‚úÖ Deployed branch {branch_name} to {target_dir}")
        EOF
        
    - name: üì§ Commit and Push to gh-pages
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add .
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Deploy ML report for branch: ${{ needs.setup-deployment-info.outputs.branch-name }}"
          git push origin gh-pages
          echo "‚úÖ Successfully pushed to gh-pages"
        fi

  notify-completion:
    name: üìß Notify Completion
    needs: [setup-deployment-info, generate-dataset, run-ml-analysis, deploy-to-pages]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: üìä Create Summary Report
      run: |
        echo "## ü§ñ Automated ML Analysis Completion Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Dataset Generation**: ${{ needs.generate-dataset.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ML Analysis**: ${{ needs.run-ml-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Pages Deployment**: ${{ needs.deploy-to-pages.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Key Features Demonstrated" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Automated dataset generation" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Multi-model ML analysis pipeline" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Automated report generation" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ GitHub Pages deployment" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Cross-platform CI/CD automation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìö Educational Value" >> $GITHUB_STEP_SUMMARY
        echo "This workflow demonstrates enterprise Python automation:" >> $GITHUB_STEP_SUMMARY
        echo "1. **Data Generation**: Synthetic educational datasets" >> $GITHUB_STEP_SUMMARY
        echo "2. **ML Pipeline**: scikit-learn classification & clustering" >> $GITHUB_STEP_SUMMARY
        echo "3. **Visualization**: matplotlib & seaborn charts" >> $GITHUB_STEP_SUMMARY
        echo "4. **Reporting**: Automated HTML report generation" >> $GITHUB_STEP_SUMMARY
        echo "5. **Deployment**: GitHub Actions + GitHub Pages integration" >> $GITHUB_STEP_SUMMARY

    - name: üéâ Success Notification
      if: needs.deploy-to-pages.result == 'success'
      run: |
        DEPLOYMENT_PATH="${{ needs.setup-deployment-info.outputs.deployment-path }}"
        BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        
        if [ -n "$DEPLOYMENT_PATH" ]; then
          FULL_URL="${BASE_URL}/${DEPLOYMENT_PATH}/"
        else
          FULL_URL="${BASE_URL}/"
        fi
        
        echo "üéâ ML Analysis Pipeline completed successfully!"
        echo "üìä Report URL: $FULL_URL"
        echo "üìä Branch: ${{ needs.setup-deployment-info.outputs.branch-name }}"
        echo "ü§ñ Perfect demonstration of Python enterprise automation!"
        
        # Add to job summary
        echo "## üéâ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Access Your ML Report:" >> $GITHUB_STEP_SUMMARY
        echo "**üîó [Click here to view the report]($FULL_URL)**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ needs.setup-deployment-info.outputs.branch-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Path**: $DEPLOYMENT_PATH" >> $GITHUB_STEP_SUMMARY
        echo "- **Direct URL**: [$FULL_URL]($FULL_URL)" >> $GITHUB_STEP_SUMMARY
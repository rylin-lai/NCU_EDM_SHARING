name: ğŸ¤– Automated ML Report Generation

on:
  push:
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  pull_request:
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  workflow_dispatch:
    inputs:
      dataset_size:
        description: 'Number of students in generated dataset'
        required: false
        default: '500'
        type: string
      semester:
        description: 'Semester identifier'
        required: false
        default: '2024_Fall'
        type: string

jobs:
  setup-deployment-info:
    name: ğŸ“‹ Setup Deployment Info
    runs-on: ubuntu-latest
    outputs:
      deployment-path: ${{ steps.path-info.outputs.deployment-path }}
      branch-name: ${{ steps.path-info.outputs.branch-name }}
      is-main-branch: ${{ steps.path-info.outputs.is-main-branch }}
      pr-number: ${{ steps.path-info.outputs.pr-number }}
      
    steps:
    - name: ğŸ” Determine Deployment Path
      id: path-info
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          PR_NUMBER="${{ github.event.pull_request.number }}"
          DEPLOYMENT_PATH="pr-${PR_NUMBER}"
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          IS_MAIN_BRANCH="false"
          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref_name }}" = "main" ] || [ "${{ github.ref_name }}" = "master" ]; then
          DEPLOYMENT_PATH=""
          BRANCH_NAME="${{ github.ref_name }}"
          IS_MAIN_BRANCH="true"
          echo "pr-number=" >> $GITHUB_OUTPUT
        else
          BRANCH_NAME="${{ github.ref_name }}"
          DEPLOYMENT_PATH="branch-${BRANCH_NAME}"
          IS_MAIN_BRANCH="false"
          echo "pr-number=" >> $GITHUB_OUTPUT
        fi
        
        echo "deployment-path=${DEPLOYMENT_PATH}" >> $GITHUB_OUTPUT
        echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "is-main-branch=${IS_MAIN_BRANCH}" >> $GITHUB_OUTPUT
        
        echo "ğŸ” Deployment Info:"
        echo "  Branch: ${BRANCH_NAME}"
        echo "  Path: ${DEPLOYMENT_PATH}"
        echo "  Is Main: ${IS_MAIN_BRANCH}"

  generate-dataset:
    name: ğŸ“Š Generate Educational Dataset
    runs-on: ubuntu-latest
    needs: setup-deployment-info
    
    outputs:
      dataset-path: ${{ steps.generate.outputs.dataset-path }}
      
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
    
    - name: ğŸ“Š Generate Educational Dataset
      id: generate
      working-directory: auto_ml_demo
      run: |
        mkdir -p data
        
        STUDENTS=${{ github.event.inputs.dataset_size || '500' }}
        SEMESTER=${{ github.event.inputs.semester || '2024_Fall' }}
        
        echo "ğŸ”„ Generating dataset with $STUDENTS students for semester $SEMESTER"
        
        python educational_dataset_generator.py \
          --students $STUDENTS \
          --semester $SEMESTER \
          --output data/ \
          --both
        
        DATASET_PATH="data/educational_data_${SEMESTER}.csv"
        echo "dataset-path=$DATASET_PATH" >> $GITHUB_OUTPUT
        
        echo "âœ… Dataset generated: $DATASET_PATH"
        ls -la data/
    
    - name: ğŸ“¤ Upload Dataset Artifact
      uses: actions/upload-artifact@v4
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        retention-days: 30

  run-ml-analysis:
    name: ğŸ¤– Run ML Analysis
    needs: [setup-deployment-info, generate-dataset]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
        
    - name: ğŸ“¥ Download Dataset
      uses: actions/download-artifact@v4
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        
    - name: ğŸ¤– Run ML Analysis
      working-directory: auto_ml_demo
      run: |
        echo "ğŸ”„ Running ML analysis on dataset: ${{ needs.generate-dataset.outputs.dataset-path }}"
        
        mkdir -p reports/plots
        
        python ml_report_generator.py \
          --data ${{ needs.generate-dataset.outputs.dataset-path }} \
          --output reports/ \
          --target Pass_course
        
        echo "âœ… ML analysis completed"
        ls -la reports/
        
    - name: ğŸ“¤ Upload ML Reports
      uses: actions/upload-artifact@v4
      with:
        name: ml-analysis-reports
        path: auto_ml_demo/reports/
        retention-days: 30

  deploy-to-pages:
    name: ğŸš€ Deploy to GitHub Pages
    needs: [setup-deployment-info, generate-dataset, run-ml-analysis]
    runs-on: ubuntu-latest
    if: success()
    
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¥ Download ML Reports
      uses: actions/download-artifact@v4
      with:
        name: ml-analysis-reports
        path: reports/
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¥ Checkout/Create gh-pages branch
      run: |
        git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages
        git checkout gh-pages
        
        if [ ! -f "index.html" ]; then
          git rm -rf . 2>/dev/null || true
          echo "ğŸ“„ Created new gh-pages branch"
        else
          echo "ğŸ“„ Using existing gh-pages branch"
        fi
        
    - name: ğŸ—ï¸ Create Simple HTML Report
      env:
        DEPLOYMENT_PATH: ${{ needs.setup-deployment-info.outputs.deployment-path }}
        BRANCH_NAME: ${{ needs.setup-deployment-info.outputs.branch-name }}
        IS_MAIN_BRANCH: ${{ needs.setup-deployment-info.outputs.is-main-branch }}
        PR_NUMBER: ${{ needs.setup-deployment-info.outputs.pr-number }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        echo "ğŸ”„ Deploying branch: ${BRANCH_NAME}"
        
        # Determine target directory
        if [ "${IS_MAIN_BRANCH}" = "true" ]; then
          TARGET_DIR="."
          echo "ğŸ“ Main branch -> root directory"
        else
          TARGET_DIR="branch-${BRANCH_NAME}"
          echo "ğŸ“ Branch '${BRANCH_NAME}' -> directory '${TARGET_DIR}'"
        fi
        
        # Create target directory
        mkdir -p "${TARGET_DIR}"
        
        # Create simple HTML report file
        REPORT_FILE="${TARGET_DIR}/index.html"
        
        cat > "${REPORT_FILE}" << 'EOF'
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python ML Demo</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        .container { 
            max-width: 1000px; margin: 0 auto; 
            background: white; border-radius: 15px; 
            padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header { 
            text-align: center; margin-bottom: 30px; 
            padding: 20px; background: #f8f9fa; border-radius: 10px;
        }
        .status-badge { 
            display: inline-block; padding: 5px 10px; 
            background: #28a745; color: white; border-radius: 15px; 
            font-size: 12px; font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– Python ML Demo</h1>
            <span class="status-badge">âœ… éƒ¨ç½²æˆåŠŸ</span>
EOF
        
        echo "            <p>Branch: ${BRANCH_NAME}</p>" >> "${REPORT_FILE}"
        
        cat >> "${REPORT_FILE}" << 'EOF'
        </div>
        <div style="text-align: center; padding: 20px;">
            <p>ML åˆ†æå ±å‘Šå·²æˆåŠŸéƒ¨ç½²ï¼</p>
            <p>æ­¤ç‚º Python è‡ªå‹•åŒ–å·¥ä½œæµç¨‹å±•ç¤º</p>
        </div>
    </div>
</body>
</html>
EOF
        
        echo "âœ… Created HTML report: ${REPORT_FILE}"
        
    - name: ğŸ“¤ Commit and Push to gh-pages
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add .
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Deploy ML report for branch: ${{ needs.setup-deployment-info.outputs.branch-name }}"
          git push origin gh-pages
          echo "âœ… Successfully pushed to gh-pages"
        fi

  notify-completion:
    name: ğŸ“§ Notify Completion
    needs: [setup-deployment-info, generate-dataset, run-ml-analysis, deploy-to-pages]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ‰ Success Notification
      if: needs.deploy-to-pages.result == 'success'
      run: |
        DEPLOYMENT_PATH="${{ needs.setup-deployment-info.outputs.deployment-path }}"
        BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        
        if [ -n "$DEPLOYMENT_PATH" ]; then
          FULL_URL="${BASE_URL}/${DEPLOYMENT_PATH}/"
        else
          FULL_URL="${BASE_URL}/"
        fi
        
        echo "ğŸ‰ ML Analysis Pipeline completed successfully!"
        echo "ğŸ“Š Report URL: $FULL_URL"
        echo "ğŸ“Š Branch: ${{ needs.setup-deployment-info.outputs.branch-name }}"
        
        echo "## ğŸ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Access Your ML Report:" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ”— [Click here to view the report]($FULL_URL)**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ needs.setup-deployment-info.outputs.branch-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Path**: $DEPLOYMENT_PATH" >> $GITHUB_STEP_SUMMARY
        echo "- **Direct URL**: [$FULL_URL]($FULL_URL)" >> $GITHUB_STEP_SUMMARY
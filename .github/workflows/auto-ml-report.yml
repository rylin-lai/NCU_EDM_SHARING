name: ğŸ¤– Automated ML Report Generation

on:
  push:
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  pull_request:
    paths: 
      - 'auto_ml_demo/**'
      - '.github/workflows/auto-ml-report.yml'
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:
    inputs:
      dataset_size:
        description: 'Number of students in generated dataset'
        required: false
        default: '500'
        type: string
      semester:
        description: 'Semester identifier'
        required: false
        default: '2024_Fall'
        type: string

jobs:
  setup-deployment-info:
    name: ğŸ“‹ Setup Deployment Info
    runs-on: ubuntu-latest
    outputs:
      deployment-path: ${{ steps.path-info.outputs.deployment-path }}
      branch-name: ${{ steps.path-info.outputs.branch-name }}
      is-main-branch: ${{ steps.path-info.outputs.is-main-branch }}
      pr-number: ${{ steps.path-info.outputs.pr-number }}
      
    steps:
    - name: ğŸ” Determine Deployment Path
      id: path-info
      run: |
        # ç¢ºå®šéƒ¨ç½²è·¯å¾‘å’Œåˆ†æ”¯è³‡è¨Š
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PR éƒ¨ç½²åˆ° pr-{number} è·¯å¾‘
          PR_NUMBER="${{ github.event.pull_request.number }}"
          DEPLOYMENT_PATH="pr-${PR_NUMBER}"
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          IS_MAIN_BRANCH="false"
          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref_name }}" = "main" ] || [ "${{ github.ref_name }}" = "master" ]; then
          # main/master åˆ†æ”¯éƒ¨ç½²åˆ°æ ¹è·¯å¾‘
          DEPLOYMENT_PATH=""
          BRANCH_NAME="${{ github.ref_name }}"
          IS_MAIN_BRANCH="true"
          echo "pr-number=" >> $GITHUB_OUTPUT
        else
          # å…¶ä»–åˆ†æ”¯éƒ¨ç½²åˆ° branch-{name} è·¯å¾‘
          BRANCH_NAME="${{ github.ref_name }}"
          DEPLOYMENT_PATH="branch-${BRANCH_NAME}"
          IS_MAIN_BRANCH="false"
          echo "pr-number=" >> $GITHUB_OUTPUT
        fi
        
        echo "deployment-path=${DEPLOYMENT_PATH}" >> $GITHUB_OUTPUT
        echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "is-main-branch=${IS_MAIN_BRANCH}" >> $GITHUB_OUTPUT
        
        echo "ğŸ” Deployment Info:"
        echo "  Branch: ${BRANCH_NAME}"
        echo "  Path: ${DEPLOYMENT_PATH}"
        echo "  Is Main: ${IS_MAIN_BRANCH}"

  generate-dataset:
    name: ğŸ“Š Generate Educational Dataset
    runs-on: ubuntu-latest
    needs: setup-deployment-info
    
    outputs:
      dataset-path: ${{ steps.generate.outputs.dataset-path }}
      
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
    
    - name: ğŸ“Š Generate Educational Dataset
      id: generate
      working-directory: auto_ml_demo
      run: |
        mkdir -p data
        
        STUDENTS=${{ github.event.inputs.dataset_size || '500' }}
        SEMESTER=${{ github.event.inputs.semester || '2024_Fall' }}
        
        echo "ğŸ”„ Generating dataset with $STUDENTS students for semester $SEMESTER"
        
        python educational_dataset_generator.py \
          --students $STUDENTS \
          --semester $SEMESTER \
          --output data/ \
          --both
        
        DATASET_PATH="data/educational_data_${SEMESTER}.csv"
        echo "dataset-path=$DATASET_PATH" >> $GITHUB_OUTPUT
        
        echo "âœ… Dataset generated: $DATASET_PATH"
        ls -la data/
    
    - name: ğŸ“¤ Upload Dataset Artifact
      uses: actions/upload-artifact@v4
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        retention-days: 30

  run-ml-analysis:
    name: ğŸ¤– Run ML Analysis
    needs: [setup-deployment-info, generate-dataset]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        cd auto_ml_demo
        pip install -r requirements.txt
        
    - name: ğŸ“¥ Download Dataset
      uses: actions/download-artifact@v4
      with:
        name: educational-dataset
        path: auto_ml_demo/data/
        
    - name: ğŸ¤– Run ML Analysis
      working-directory: auto_ml_demo
      run: |
        echo "ğŸ”„ Running ML analysis on dataset: ${{ needs.generate-dataset.outputs.dataset-path }}"
        
        mkdir -p reports/plots
        
        python ml_report_generator.py \
          --data ${{ needs.generate-dataset.outputs.dataset-path }} \
          --output reports/ \
          --target Pass_course
        
        echo "âœ… ML analysis completed"
        ls -la reports/
        
    - name: ğŸ“¤ Upload ML Reports
      uses: actions/upload-artifact@v4
      with:
        name: ml-analysis-reports
        path: auto_ml_demo/reports/
        retention-days: 30

  deploy-to-pages:
    name: ğŸš€ Deploy to GitHub Pages
    needs: [setup-deployment-info, generate-dataset, run-ml-analysis]
    runs-on: ubuntu-latest
    # ç§»é™¤ç’°å¢ƒä¿è­·é™åˆ¶ï¼Œå…è¨±æ‰€æœ‰åˆ†æ”¯éƒ¨ç½²
    if: success()
    
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download ML Reports
      uses: actions/download-artifact@v4
      with:
        name: ml-analysis-reports
        path: reports/
        
    - name: ğŸ Set up Python for Pages Structure
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¥ Download Existing Pages (for multi-branch support)
      continue-on-error: true
      run: |
        # å˜—è©¦ä¸‹è¼‰ç¾æœ‰çš„GitHub Pageså…§å®¹
        mkdir -p existing_pages
        curl -L -f -s "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" -o existing_pages/index.html || echo "No existing pages found"
        
    - name: ğŸ—ï¸ Create Multi-Branch Pages Structure
      working-directory: auto_ml_demo
      env:
        DEPLOYMENT_PATH: ${{ needs.setup-deployment-info.outputs.deployment-path }}
        BRANCH_NAME: ${{ needs.setup-deployment-info.outputs.branch-name }}
        IS_MAIN_BRANCH: ${{ needs.setup-deployment-info.outputs.is-main-branch }}
        PR_NUMBER: ${{ needs.setup-deployment-info.outputs.pr-number }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        echo "ğŸ”„ Creating pages structure for branch: ${BRANCH_NAME}"
        echo "ğŸ”„ Deployment path: ${DEPLOYMENT_PATH}"
        
        # å‰µå»ºåŸºæœ¬çµæ§‹
        python create_pages_structure.py
        
        # å¦‚æœä¸æ˜¯ä¸»åˆ†æ”¯ï¼Œéœ€è¦èª¿æ•´çµæ§‹
        if [ "${IS_MAIN_BRANCH}" = "false" ]; then
          echo "ğŸ“ Creating sub-directory structure for non-main branch"
          mkdir -p "public_temp/${DEPLOYMENT_PATH}"
          mv public/* "public_temp/${DEPLOYMENT_PATH}/" 2>/dev/null || true
          mv public_temp/* public/ 2>/dev/null || true
          rmdir public_temp 2>/dev/null || true
        fi
        
        # å‰µå»ºæˆ–æ›´æ–°ä¸»ç´¢å¼•é é¢ï¼ˆåˆ—å‡ºæ‰€æœ‰éƒ¨ç½²ï¼‰
        python - << 'EOF'
        import os
        import json
        import datetime
        from pathlib import Path
        
        deployment_path = os.environ.get('DEPLOYMENT_PATH', '')
        branch_name = os.environ.get('BRANCH_NAME', 'unknown')
        is_main_branch = os.environ.get('IS_MAIN_BRANCH') == 'true'
        pr_number = os.environ.get('PR_NUMBER', '')
        repo_name = os.environ.get('GITHUB_REPOSITORY', '').split('/')[-1]
        actor = os.environ.get('GITHUB_ACTOR', 'unknown')
        
        # è®€å–æˆ–å‰µå»ºéƒ¨ç½²è¨˜éŒ„
        deployments_file = Path('public/deployments.json')
        deployments = {}
        
        if deployments_file.exists():
            try:
                with open(deployments_file, 'r') as f:
                    deployments = json.load(f)
            except:
                deployments = {}
        
        # æ›´æ–°ç•¶å‰éƒ¨ç½²è¨˜éŒ„
        deployment_info = {
            'branch': branch_name,
            'path': deployment_path,
            'is_main': is_main_branch,
            'pr_number': pr_number if pr_number else None,
            'actor': actor,
            'timestamp': datetime.datetime.now().isoformat(),
            'url': f"./{deployment_path}/" if deployment_path else "./"
        }
        
        deployment_key = deployment_path if deployment_path else 'main'
        deployments[deployment_key] = deployment_info
        
        # ä¿å­˜éƒ¨ç½²è¨˜éŒ„
        with open(deployments_file, 'w') as f:
            json.dump(deployments, f, indent=2)
        
        # å¦‚æœæ˜¯ä¸»åˆ†æ”¯ï¼Œå‰µå»ºç¸½è¦½é é¢
        if is_main_branch or not deployment_path:
            main_index_html = f'''<!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ğŸ“ ML Workshop - All Deployments</title>
            <style>
                body {{ 
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                    margin: 0; padding: 20px; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                }}
                .container {{ 
                    max-width: 1200px; margin: 0 auto; 
                    background: white; border-radius: 15px; 
                    padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                }}
                .header {{ 
                    text-align: center; margin-bottom: 40px; 
                    padding: 20px; background: #f8f9fa; 
                    border-radius: 10px;
                }}
                .deployments-grid {{ 
                    display: grid; 
                    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
                    gap: 20px; margin: 30px 0; 
                }}
                .deployment-card {{ 
                    background: white; padding: 20px; 
                    border-radius: 10px; border: 2px solid #e9ecef; 
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                    border-left: 4px solid #007bff;
                }}
                .deployment-card:hover {{ 
                    transform: translateY(-5px); 
                    box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
                }}
                .deployment-card.main {{ border-left-color: #28a745; }}
                .deployment-card.pr {{ border-left-color: #ffc107; }}
                .deployment-card.branch {{ border-left-color: #17a2b8; }}
                .deployment-title {{ 
                    font-size: 18px; font-weight: bold; 
                    margin-bottom: 10px; color: #495057; 
                }}
                .deployment-info {{ 
                    font-size: 14px; color: #6c757d; 
                    margin: 5px 0; 
                }}
                .deployment-link {{ 
                    display: inline-block; padding: 10px 20px; 
                    background: #007bff; color: white; 
                    text-decoration: none; border-radius: 6px; 
                    margin-top: 15px; transition: background 0.3s ease;
                }}
                .deployment-link:hover {{ background: #0056b3; }}
                .timestamp {{ 
                    color: #6c757d; font-style: italic; 
                    text-align: center; margin-top: 30px; 
                    font-size: 12px;
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸ“ ML Workshop - Student Deployments</h1>
                    <h2>æ©Ÿå™¨å­¸ç¿’å·¥ä½œåŠ - å­¸ç”Ÿéƒ¨ç½²ç¸½è¦½</h2>
                    <p>æ¯å€‹å­¸ç”Ÿçš„åˆ†æ”¯å’ŒPRéƒ½æœ‰ç¨ç«‹çš„MLåˆ†æå ±è¡¨ / Each student branch and PR has its own ML analysis report</p>
                </div>
                
                <div class="deployments-grid">'''
            
            # æ·»åŠ å„å€‹éƒ¨ç½²
            sorted_deployments = sorted(deployments.items(), key=lambda x: (x[1]['is_main'], x[1]['timestamp']))
            
            for deploy_key, deploy_info in sorted_deployments:
                card_class = "main" if deploy_info['is_main'] else ("pr" if deploy_info.get('pr_number') else "branch")
                title = "ğŸ  Main Branch" if deploy_info['is_main'] else (f"ğŸ”„ PR #{deploy_info.get('pr_number')}" if deploy_info.get('pr_number') else f"ğŸŒ¿ Branch: {deploy_info['branch']}")
                
                main_index_html += f'''
                    <div class="deployment-card {card_class}">
                        <div class="deployment-title">{title}</div>
                        <div class="deployment-info">ğŸ‘¤ Author: {deploy_info['actor']}</div>
                        <div class="deployment-info">ğŸ•’ Updated: {deploy_info['timestamp'][:19].replace('T', ' ')}</div>
                        {'<div class="deployment-info">ğŸ“ Branch: ' + deploy_info['branch'] + '</div>' if not deploy_info['is_main'] else ''}
                        <a href="{deploy_info['url']}" class="deployment-link">View Report æª¢è¦–å ±è¡¨ â†’</a>
                    </div>'''
            
            main_index_html += f'''
                </div>
                
                <div class="timestamp">
                    Last updated: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}<br>
                    Repository: {repo_name} | Total deployments: {len(deployments)}
                </div>
            </div>
            
            <script>
                // è‡ªå‹•é‡æ–°æ•´ç†ï¼ˆæ¯5åˆ†é˜ï¼‰
                setTimeout(() => location.reload(), 300000);
            </script>
        </body>
        </html>'''
            
            with open('public/index.html', 'w', encoding='utf-8') as f:
                f.write(main_index_html)
        
        print(f"âœ… Multi-branch pages structure created for {branch_name}")
        print(f"ğŸ“ Deployment path: {deployment_path or 'root'}")
        EOF
        
        echo "âœ… Pages structure completed"
        find public -name "*.html" | head -10
        
    - name: ğŸ“¤ Setup Pages
      uses: actions/configure-pages@v4
      continue-on-error: true
      
    - name: ğŸ“¤ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: auto_ml_demo/public/
        
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        # å…è¨±å¾ä»»ä½•åˆ†æ”¯éƒ¨ç½²ï¼Œä¸å—ç’°å¢ƒä¿è­·è¦å‰‡é™åˆ¶
        environment_override: false

  notify-completion:
    name: ğŸ“§ Notify Completion
    needs: [setup-deployment-info, generate-dataset, run-ml-analysis, deploy-to-pages]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š Create Summary Report
      run: |
        echo "## ğŸ¤– Automated ML Analysis Completion Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Dataset Generation**: ${{ needs.generate-dataset.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ML Analysis**: ${{ needs.run-ml-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Pages Deployment**: ${{ needs.deploy-to-pages.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Key Features Demonstrated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Automated dataset generation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Multi-model ML analysis pipeline" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Automated report generation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… GitHub Pages deployment" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Cross-platform CI/CD automation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“š Educational Value" >> $GITHUB_STEP_SUMMARY
        echo "This workflow demonstrates enterprise Python automation:" >> $GITHUB_STEP_SUMMARY
        echo "1. **Data Generation**: Synthetic educational datasets" >> $GITHUB_STEP_SUMMARY
        echo "2. **ML Pipeline**: scikit-learn classification & clustering" >> $GITHUB_STEP_SUMMARY
        echo "3. **Visualization**: matplotlib & seaborn charts" >> $GITHUB_STEP_SUMMARY
        echo "4. **Reporting**: Automated HTML report generation" >> $GITHUB_STEP_SUMMARY
        echo "5. **Deployment**: GitHub Actions + GitHub Pages integration" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ‰ Success Notification
      if: needs.deploy-to-pages.result == 'success'
      run: |
        echo "ğŸ‰ ML Analysis Pipeline completed successfully!"
        echo "ğŸ“Š Report available at GitHub Pages"
        echo "ğŸ¤– Perfect demonstration of Python enterprise automation!"